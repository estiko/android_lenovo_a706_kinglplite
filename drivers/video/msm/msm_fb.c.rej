--- drivers/video/msm/msm_fb.c
+++ drivers/video/msm/msm_fb.c
@@ -72,7 +75,7 @@
 #endif
 #endif
 
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
 
 /*modify the number of framebuffer*/
 /*Add 4 framebuffer and delete the mem adapter strategy*/	
@@ -152,13 +155,16 @@
 int msm_fb_set_dynamic_gamma(struct msm_fb_data_type *mfd, enum danymic_gamma_mode gamma_mode);
 #endif
 
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
 
 #ifdef MSM_FB_ENABLE_DBGFS
 
 #define MSM_FB_MAX_DBGFS 1024
 #define MAX_BACKLIGHT_BRIGHTNESS 255
 
+/* 200 ms for time out */
+#define WAIT_FENCE_TIMEOUT 200
+
 int msm_fb_debugfs_file_index;
 struct dentry *msm_fb_debugfs_root;
 struct dentry *msm_fb_debugfs_file[MSM_FB_MAX_DBGFS];
@@ -1945,6 +1961,7 @@
 	struct mdp_dirty_region dirty;
 	struct mdp_dirty_region *dirtyPtr = NULL;
 	struct msm_fb_data_type *mfd = (struct msm_fb_data_type *)info->par;
+        int i, ret;
 /* < lishubin update baseline to J version begin */
 #ifndef CONFIG_HUAWEI_KERNEL
 	struct msm_fb_panel_data *pdata;
@@ -1955,7 +1972,7 @@
     static bool is_first_frame = TRUE;
 #endif
 
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
     
 	/*
 	 * If framebuffer is 2, io pen display is not allowed.
@@ -2062,6 +2093,12 @@
 	else
 #endif
 	mdp_dma_pan_update(info);
+	if (mfd->timeline) {
+		sw_sync_timeline_inc(mfd->timeline, 1);
+		mfd->timeline_value++;
+	}
+	mfd->last_rel_fence = mfd->cur_rel_fence;
+	mfd->cur_rel_fence = 0;
 	up(&msm_fb_pan_sem);
 
 /* Remove qcom backlight mechanism,user our own */
@@ -2466,7 +2503,7 @@
 	}
 #endif
 
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
 
 	if (unlikely(req->src_rect.h == 0 || req->src_rect.w == 0)) {
 		printk(KERN_ERR "mpd_ppp: src img of zero size!\n");
@@ -3703,6 +3740,77 @@
 	}
 	return ret;
 }
+static int msmfb_handle_buf_sync_ioctl(struct msm_fb_data_type *mfd,
+						struct mdp_buf_sync *buf_sync)
+{
+	int i, fence_cnt = 0, ret;
+	int acq_fen_fd[MDP_MAX_FENCE_FD];
+	struct sync_fence *fence;
+
+	if ((buf_sync->acq_fen_fd_cnt == 0) ||
+		(buf_sync->acq_fen_fd_cnt > MDP_MAX_FENCE_FD) ||
+		(mfd->timeline == NULL))
+		return -EINVAL;
+
+	ret = copy_from_user(acq_fen_fd, buf_sync->acq_fen_fd,
+			buf_sync->acq_fen_fd_cnt * sizeof(int));
+	if (ret) {
+		pr_err("%s:copy_from_user failed", __func__);
+		return ret;
+	}
+	for (i = 0; i < buf_sync->acq_fen_fd_cnt; i++) {
+		fence = sync_fence_fdget(acq_fen_fd[i]);
+		if (fence == NULL) {
+			pr_info("%s: null fence! i=%d fd=%d\n", __func__, i,
+				acq_fen_fd[i]);
+			ret = -EINVAL;
+			break;
+		}
+		mfd->acq_fen[i] = fence;
+	}
+	fence_cnt = i;
+	if (ret)
+		goto buf_sync_err_1;
+	mfd->cur_rel_sync_pt = sw_sync_pt_create(mfd->timeline,
+			mfd->timeline_value + 2);
+	if (mfd->cur_rel_sync_pt == NULL) {
+		pr_err("%s: cannot create sync point", __func__);
+		ret = -ENOMEM;
+		goto buf_sync_err_1;
+	}
+	/* create fence */
+	mfd->cur_rel_fence = sync_fence_create("mdp-fence",
+			mfd->cur_rel_sync_pt);
+	if (mfd->cur_rel_fence == NULL) {
+		pr_err("%s: cannot create fence", __func__);
+		ret = -ENOMEM;
+		goto buf_sync_err_2;
+	}
+	/* create fd */
+	mfd->cur_rel_fen_fd = get_unused_fd_flags(0);
+	sync_fence_install(mfd->cur_rel_fence, mfd->cur_rel_fen_fd);
+	ret = copy_to_user(buf_sync->rel_fen_fd,
+		&mfd->cur_rel_fen_fd, sizeof(int));
+	if (ret) {
+		pr_err("%s:copy_to_user failed", __func__);
+		goto buf_sync_err_3;
+	}
+	mfd->acq_fen_cnt = buf_sync->acq_fen_fd_cnt;
+	return ret;
+buf_sync_err_3:
+	sync_fence_put(mfd->cur_rel_fence);
+	put_unused_fd(mfd->cur_rel_fen_fd);
+	mfd->cur_rel_fence = NULL;
+	mfd->cur_rel_fen_fd = 0;
+buf_sync_err_2:
+	sync_pt_free(mfd->cur_rel_sync_pt);
+	mfd->cur_rel_sync_pt = NULL;
+buf_sync_err_1:
+	for (i = 0; i < fence_cnt; i++)
+		sync_fence_put(mfd->acq_fen[i]);
+	mfd->acq_fen_cnt = 0;
+	return ret;
+}
 static int msm_fb_ioctl(struct fb_info *info, unsigned int cmd,
 			unsigned long arg)
 {
@@ -3724,6 +3832,7 @@
 	struct mdp_page_protection fb_page_protection;
 	struct msmfb_mdp_pp mdp_pp;
 	struct msmfb_metadata mdp_metadata;
+        struct mdp_buf_sync buf_sync;
 	int ret = 0;
 
 	switch (cmd) {
@@ -4292,7 +4411,7 @@
 #ifdef CONFIG_HUAWEI_EVALUATE_POWER_CONSUMPTION 
 static void __exit msm_fb_exit(void)
 {
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
 
      /*lcd consume notify timer cancel*/
 	 del_timer(&bright_timer);
@@ -4328,7 +4447,7 @@
 	INIT_WORK(&light_notify_work, light_notify_work_func);  
 #endif
 
-/* É¾³ý´Ë¶Î´úÂë */
+/* É¾ï¿½ï¿½Ë¶Î´ï¿½ï¿½ï¿½ */
 
 	return 0;
 }
